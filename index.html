<!DOCTYPE html>
<html>
<head>
   <title>Artwork Rating Study</title>
   <!-- Core jsPsych -->
   <script src="https://unpkg.com/jspsych@7.3.3"></script>
   <!-- jsPsych plugins -->
   <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
   <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.2"></script>
   <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
   <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
   <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
   <!-- jsPsych stylesheet -->
   <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css"/>
   <!-- Font Awesome for arrow icon -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   <!-- Font Poppins -->
   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
   <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        /* Add these new banner styles first */
        .banner {
            width: 100%;
            background-color: white;
            padding: 10px;
            text-align: center;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            box-sizing: border-box;
        }

        .banner img {
            max-width: 400px;
            width: 90%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* Media queries for different screen sizes */
        @media screen and (max-width: 768px) {
            .banner {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .banner img {
                max-width: 350px;
            }
        }

        @media screen and (max-width: 480px) {
            .banner {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .banner img {
                max-width: 300px;
            }
        }

       .artwork-container {
           max-width: 100%;
           margin: 0 auto;
           padding: 20px;
           font-family: "Open Sans", "Arial", sans-serif;
       }
       .question-text {
           font-weight: bold;
           font-size: 1.25em;
           margin-bottom: 20px;
       }
       .instructions {
           text-align: left;
           max-width: 800px;
           margin: 0 auto;
       }
       .instructions h2 {
           text-align: center;
           margin-bottom: 30px;
       }
       .artwork-image {
           width: 400px;
           height: 300px;
           object-fit: contain;
           margin: 20px auto;
           display: block;
           border: 2px solid black;
           padding: 10px;
           background-color: white;
           margin-left: auto;
           margin-right: auto;
       }
       textarea {
           width: 100%;
           height: 100px;
           margin: 20px 0;
           padding: 15px;
           font-size: 16px;
           border: 1px solid #ccc;
           border-radius: 4px;
           resize: vertical;
           font-family: inherit;
       }
       .continue-btn {
           background-color: #007AC0;
           color: white;
           padding: 10px 20px;
           border: none;
           border-radius: 4px;
           cursor: pointer;
           font-size: 16px;
           display: inline-flex;
           align-items: center;
           gap: 10px;
           font-family: 'Poppins', sans-serif;
       }
       .continue-btn:hover {
           background-color: #006AA6;
       }
       .form-group {
           margin-bottom: 20px;
       }
       .form-input {
           width: 100%;
           max-width: 200px;
           padding: 8px;
           margin: 5px 0;
           border: 1px solid #ccc;
           border-radius: 4px;
           font-size: 16px;
       }
       .radio-group {
           display: flex;
           flex-direction: column;
           gap: 10px;
           margin-top: 10px;
       }
       .radio-option {
           display: flex;
           align-items: center;
           gap: 10px;
       }
       .radio-option input[type="radio"] {
           margin: 0;
       }
       .radio-option label {
           margin: 0;
           font-size: 16px;
       }
       .consent-options {
           display: flex;
           justify-content: center;
           gap: 20px;
           margin-top: 30px;
       }
       .prolific-id-input {
           width: 100%;
           max-width: 300px;
           padding: 10px;
           margin: 10px 0;
           border: 1px solid #ccc;
           border-radius: 4px;
           font-size: 16px;
       }
       @media (max-width: 768px) {
           .artwork-container {
               padding: 10px;
           }
           .artwork-image {
               width: 90%;
               height: auto;
               max-width: 400px;
           }
       }
       /* Remove the default jsPsych button */
       .jspsych-btn {
           display: none !important;
       }
       
       .artwork-heading {
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 20px;
        font-family: 'Poppins', sans-serif;
        }

        .social-condition {
            background-color: rgb(250, 249, 246);
            padding: 20px;
            margin: 20px 0;
            border-top: 3px solid #888;
            border-bottom: 3px solid #888;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .social-condition p {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            color: #444;
        }

        /* Smaller system info text */
        .system-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            font-size: 0.75em;
            color: #666;
        }

        .system-info::before {
            content: "↳";
            color: #888;
            font-family: monospace;
        }

        .system-text {
            color: #666;
            font-family: monospace;
        }

        .timestamp {
            color: #888;
            font-family: monospace;
        }
        
        .participant-name {
            display: inline-flex;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 4px 8px;
            height: 28px;
            color: #0066cc;
            position: relative;
        }

        .participant-name::before {
            content: "ID: ";
            color: #888;
            font-family: 'Courier New', monospace;
            margin-right: 4px;
            font-size: 0.85em;
        }

        /* Matching preference container styling */
        .preference-container {
            display: inline-flex;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 4px 8px;
            height: 28px;
            position: relative;
        }

        .preference-label {
            font-family: 'Courier New', monospace;
            color: #888;
            font-size: 0.85em;
            margin-right: 4px;
        }

        .preference-text {
            display: inline-flex;
            align-items: center;
            height: 26px;
            background-color: #e8f1f9;
            border: 1px solid #0C6DD0;
            border-radius: 3px;
            padding: 0 8px;
            color: #333;
            font-size: 0.9em;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Style for no preference condition */
        .no-preference-text {
            color: #666;
            font-style: italic;
            padding: 6px 0;
        }
        
        /* Loading spinner */
        .loading-container {
            text-align: center;
            padding: 40px 20px;
        }

        .loading-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 30px;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Matching result container */
        .matching-result {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .matching-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
        }

        /* Container for the matched participant name */
        .matched-name-container {
            display: inline-flex;
            justify-content: center;
            margin-top: 15px;
        }

        .decline-btn {
            background-color: #f5f5f5;
            color: #007AC0;
            padding: 10px 20px;
            border: 2px solid #007AC0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .decline-btn:hover {
            background-color: #e5e5e5;
        }

        .participant-id {
            display: inline-flex;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 4px 8px;
            height: 28px;
            color: #0066cc;
            position: relative;
            font-family: monospace;
        }

        .participant-id::before {
            content: "ID: ";
            color: #888;
            margin-right: 4px;
            font-size: 0.85em;
        }

        .hidden-id {
            color: #999;
            letter-spacing: 0.5px;
        }

        #jspsych-progress-bar-container {
            color: #007AC0;
            border-bottom: 2px solid #eee;
            width: 100%;
            padding: 4px 0;
            background-color: #f9f9f9;
            position: fixed;
            top: 0;
            z-index: 1000;
        }

        .jspsych-progress-bar-outer {
            background-color: #eee;
            border-radius: 10px;
            padding: 1px;
            width: 80%;
            margin: auto;
        }

        .jspsych-progress-bar-inner {
            background-color: #007AC0;
            border-radius: 10px;
            height: 15px;
            width: 0%;
        }

        /* Add padding to account for fixed progress bar */
        .banner {
            margin-top: 10px;
        }
                
   </style>
</head>
<body>
   <script>
   // Initialize jsPsych
    const jsPsych = initJsPsych({
        use_webaudio: false,
        show_progress_bar: true,
        auto_update_progress_bar: true, // Change this to true
        message_progress_bar: 'Completion Progress',
        on_finish: function() {
            const csv = jsPsych.data.get().csv();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'artwork_ratings_data.csv';
            a.click();
        }
    });

    function generateParticipantId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let id = '';
        for (let i = 0; i < 24; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return id;
    }

    const PARTICIPANT_IDS = {
        artwork: generateParticipantId(),
        colors: generateParticipantId(),
        shapes: generateParticipantId(),
        trends: generateParticipantId()
    };

    function disableCopyPaste(element) {
        element.oncut = e => e.preventDefault();
        element.oncopy = e => e.preventDefault();
        element.onpaste = e => e.preventDefault();
        element.ondrop = e => e.preventDefault();
        element.ondragstart = e => e.preventDefault();
    };


   // Define your stimuli
   const stimuli = [
       { id: 1, image: 'artwork1.jpg' },
       { id: 2, image: 'artwork2.jpg' },
       { id: 3, image: 'artwork3.jpg' },
       { id: 4, image: 'artwork4.jpg' },
       { id: 5, image: 'artwork5.jpg' },
       { id: 6, image: 'artwork6.jpg' }
   ];
   
   // NEW Add the color stimuli here
   const colorStimuli = [
       { id: 1, combination: 'Blue and Yellow' },
       { id: 2, combination: 'Green and Orange' },
       { id: 3, combination: 'Black and Red' },
       { id: 4, combination: 'Brown and Pink' },
       { id: 5, combination: 'Blue and Green' },
       { id: 6, combination: 'Yellow and Purple' }
   ];
   // Define shape stimuli
   //const shapeStimuli = [
       //{ id: 1, shape: 'A Circle' },
       //{ id: 2, shape: 'A Triangle' },
       //{ id: 3, shape: 'A Rectangle' },
       //{ id: 4, shape: 'A Square' },
       //{ id: 5, shape: 'An Oval' },
       //{ id: 6, shape: 'A Line' }
   //];

   const shapeStimuli = [
       { id: 1, image: 'circle.jpg' },
       { id: 2, image: 'triangle.jpg' },
       { id: 3, image: 'rectangle.jpg' },
       { id: 4, image: 'octagon.jpg' },
       { id: 5, image: 'oval.jpg' },
       { id: 6, image: 'line.jpg' }
   ];

   const trendStimuli = [
        { id: 1, trend: 'Artificial Intelligence' },
        { id: 2, trend: 'Biohacking' },
        { id: 3, trend: 'Blockchain' },
        { id: 4, trend: 'Genetic Engineering' },
        { id: 5, trend: 'Autonomous vehicles' },
        { id: 6, trend: 'Virtual Reality' }
    ];

   // Prolific ID input
   const prolificId = {
       type: jsPsychSurveyHtmlForm,
       html: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
           <div class="instructions">
               <h2>Please enter your unique <strong>Prolific ID</strong>:</h2>
               <input type="text" name="prolific_id" class="prolific-id-input" required>
               <button type="submit" class="continue-btn">
                   Continue <i class="fas fa-arrow-right"></i>
               </button>
           </div>
       `,
       data: {
           task: 'prolific_id'
       }
   };


   // Welcome screen with study requirements
   const welcomeScreen = {
       type: jsPsychHtmlButtonResponse,
       stimulus: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
           <div class="instructions">
               <h2><strong>A warm welcome to our research study!</strong></h2>
               <p>Thank you for considering our study.</p>
               <p>In this study it is crucial that your are able to focus for about 30 minutes.</p>
               <ul style="text-align: left; list-style-type: disc; margin-left: 30px;">
               <li style="margin-bottom: 10px;">Please only proceed if you can allocate your full attention for the duration of the study.</li>
               <li style="margin-bottom: 10px;">Please close all other tabs in your browser (other than Prolific's) before you begin.</li>
               <li style="margin-bottom: 10px;">Please avoid distractions from your phone/ email, so you can focus on this study.</li></ul>
               <p>Thank you for understanding and we hope you will enjoy it!</p>
           </div>
       `,
       choices: ['Continue'],
       button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
   };


   // Consent information page 1
   const consentInfo1 = {
       type: jsPsychHtmlButtonResponse,
       stimulus: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
           <div class="instructions">
               <h2><strong>We need your consent to proceed - Information Sheet for Participants (Behavioural) (1/2)</strong></h2>
              
               <p><strong>Title of Study:</strong> Decision-making (Behavioural)</p>
              
               <p><strong>(Consent Form 1/2)</strong></p>
              
               <p>Click to continue to read the Information Sheet</p>
           </div>
       `,
       choices: ['Continue'],
       button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
   };


   // Consent information page 2 with options
    const consentInfo2 = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h2>We need your consent to proceed - Information Sheet for Participants (Behavioural) (2/2)</h2>
            
                <p>You should read the information below, and ask questions about anything you do not understand before deciding whether or not to participate.</p>
            </div>
        `,
        choices: ['I agree to participate', 'No thanks. I do not want to participate'],
        button_html: [
            '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>',
            '<button class="decline-btn">%choice%</button>'
        ],
        on_finish: function(data) {
            if (data.response === 1) {
                jsPsych.endExperiment('Thank you for your interest. The experiment has ended.');
            }
        }
    };

   // Task instructions
   const taskInstructions = {
       type: jsPsychHtmlButtonResponse,
       stimulus: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
            <div class="instructions">
                <h3 style="text-align: center; margin-bottom: 30px;">Artwork task - please read the following instructions carefully:</h3>
                
                <p>We are interested in your preferences regarding different <strong>artworks</strong>. 
                In this task you will be asked to <strong>share your opinions about them.</strong></p>
                
                <p>For some of the artworks (not all) you might see <strong>the preferences of one of the participants from our pilot study</strong>. 
                In that pilot study, our participants could share their preference by choosing one of the following two options only: 
                <strong>"I like it a lot"</strong> or <strong>"I do not like it at all"</strong>.</p>
                
                <div class="example-container" style="width: 100%; margin: 30px 0; text-align: center;">
                    <!-- Question text -->
                    <p style="text-align: center; font-size: 18px; font-style: italic; margin-bottom: 20px;">
                        What is your opinion about the artwork above?
                    </p>
                    
                    <!-- Image of the response options -->
                    <img src="https://raw.githubusercontent.com/ADResearch1/ExpHAI/main/Q_only.png" style="max-width: 78%; height: auto;">
                </div>
                
                <p>You will be <strong>matched with one specific participant</strong> from the pilot study 
                throughout this task and will see her/his/their chosen preference for each artwork. Are you ready?</p>
            </div>
       `,
       choices: ['Continue'],
       button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
   };

    // NEW Add these new constants
    const transitionScreen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h2>Well done! You have completed the first task. Now you will move on to the next!</h2>
            </div>
        `,
        choices: ['Continue'],
        button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
    };

    const colorTaskInstructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
            <div class="instructions">
                <h3 style="text-align: center; margin-bottom: 30px;">Colour combination task- please read the following instructions carefully:</h3>
                
                <p>Now, we are interested in your preferences regarding different <strong>colour combinations</strong>. 
                In this task you will be asked to <strong>share your opinions about them.</strong></p>
                
                <p>Again, for some of the colour combinations (not all) you might see <strong>the preferences of one of the participants from our pilot study</strong>. 
                In that pilot study, our participants could share their preference by choosing one of the following two options only: 
                <strong>"I like it a lot"</strong> or <strong>"I do not like it at all"</strong>.</p>
                
                <div class="example-container" style="width: 100%; margin: 30px 0; text-align: center;">
                    <!-- Question text -->
                    <p style="text-align: center; font-size: 18px; font-style: italic; margin-bottom: 20px;">
                        What is your opinion about the colour combination above?
                    </p>
                    
                    <!-- Image of the response options -->
                    <img src="https://raw.githubusercontent.com/ADResearch1/ExpHAI/main/Q_only.png" style="max-width: 78%; height: auto;">
                </div>
                
                <p>You will be <strong>matched with one specific participant (a different one than for the last task)</strong> from the pilot study 
                throughout this task and will see her/his/their chosen preference for each colour combination. Are you ready?</p>
            </div>
        `,
        choices: ['Continue'],
        button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
    };
    // Transition to shape task
   const shapeTransitionScreen = {
       type: jsPsychHtmlButtonResponse,
       stimulus: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
           <div class="instructions">
               <h2>Nice work! You have completed your second task. Now you will move on to the final task!</h2>
           </div>
       `,
       choices: ['Continue'],
       button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
   };

   const trendTransitionScreen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h2>Excellent progress! You have completed another task. Now you will move on to the next one!</h2>
            </div>
        `,
        choices: ['Continue'],
        button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
    };

   // Shape task instructions
   const shapeTaskInstructions = {
       type: jsPsychHtmlButtonResponse,
       stimulus: `
           <div class="banner">
               <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
           </div>
            <div class="instructions">
                <h3 style="text-align: center; margin-bottom: 30px;">Shape task - please read the following instructions carefully:</h3>
                
                <p>Now, we are interested in your preferences regarding different <strong>shapes</strong>. 
                In this task you will be asked to <strong>share your opinions about them.</strong></p>
                
                <p>Again, for some of the shapes (not all) you might see <strong>the preferences of one of the participants from our pilot study</strong>. 
                In that pilot study, our participants could share their preference by choosing one of the following two options only: 
                <strong>"I like it a lot"</strong> or <strong>"I do not like it at all"</strong>.</p>
                
                <div class="example-container" style="width: 100%; margin: 30px 0; text-align: center;">
                    <!-- Question text -->
                    <p style="text-align: center; font-size: 18px; font-style: italic; margin-bottom: 20px;">
                        What is your opinion about the shape above?
                    </p>
                    
                    <!-- Image of the response options -->
                    <img src="https://raw.githubusercontent.com/ADResearch1/ExpHAI/main/Q_only.png" style="max-width: 78%; height: auto;">
                </div>
                
                <p>You will be <strong>matched with one specific participant (a different one than for the last 2 tasks)</strong> from the pilot study 
                throughout this task and will see her/his/their chosen preference for each shape. Are you ready?</p>
            </div>
       `,
       choices: ['Continue'],
       button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
   };

   const trendTaskInstructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h3 style="text-align: center; margin-bottom: 30px;">Technological innovation rating task - please read the following instructions carefully:</h3>
                
                <p>Now, we are interested in your opinions regarding different <strong>tech innovations</strong>. 
                In this task you will be asked to <strong>share your opinions about them.</strong></p>
                
                <p>Again, for some of the technological innovations (not all) you might see <strong>the preferences of one of the participants from our pilot study</strong>. 
                In that pilot study, our participants could share their preference by choosing one of the following two options only: 
                <strong>"I like it a lot"</strong> or <strong>"I do not like it at all"</strong>.</p>
                
                <div class="example-container" style="width: 100%; margin: 30px 0; text-align: center;">
                    <p style="text-align: center; font-size: 18px; font-style: italic; margin-bottom: 20px;">
                        What is your opinion about the tech innovations above?
                    </p>
                    
                    <img src="https://raw.githubusercontent.com/ADResearch1/ExpHAI/main/Q_only.png" style="max-width: 78%; height: auto;">
                </div>
                
                <p>You will be <strong>matched with one specific participant (a different one than for the other tasks)</strong> from the pilot study 
                throughout this task and will see her/his/their chosen preference for each tech innovation. Are you ready?</p>
            </div>
        `,
        choices: ['Continue'],
        button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>'
    };

    const finalQuestions = {
        type: jsPsychSurveyHtmlForm,
        html: `
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h2>Final Questions</h2>
                <p>Lastly, we would like you to reflect on the study and answer a few questions about it:</p>
                
                <div class="form-group">
                    <label class="question-label" style="font-weight: bold;">1. What were the most important influences on your opinions throughout the study?</label>
                    <textarea 
                        name="influences" 
                        class="form-input" 
                        style="width: 100%; height: 100px; max-width: 800px;"
                        required
                        placeholder="Please provide your answer here..."></textarea>
                </div>

                <div class="form-group" style="margin-top: 40px; margin-bottom: 40px;">
                    <label class="question-label" style="font-weight: bold;">2. Do you think the opinions of the participants from the pilot study were more positive, negative or similar to yours on average?</label>
                    <div class="radio-options-horizontal" style="display: flex; gap: 30px; margin-top: 25px; margin-bottom: 25px;">
                        <label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="opinion_comparison" value="more_positive" required>
                            <span>More positive on average</span>
                        </label>
                        <label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="opinion_comparison" value="more_negative" required>
                            <span>More negative on average</span>
                        </label>
                        <label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="opinion_comparison" value="similar" required>
                            <span>Similar sentiment on average</span>
                        </label>
                        <label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                            <input type="radio" name="opinion_comparison" value="n_a" required>
                            <span>Unable to say</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="question-label" style="font-weight: bold;">3. What do you generally think of the opinions of the participants from the pilot study?</label>
                    <textarea 
                        name="pilot_opinions" 
                        class="form-input" 
                        style="width: 100%; height: 100px; max-width: 800px;"
                        required
                        placeholder="Please provide your answer here..."></textarea>
                </div>

                <div class="form-group">
                    <label class="question-label" style="font-weight: bold;">4. Lastly, what do you think we were testing in this study?</label>
                    <textarea 
                        name="study_purpose" 
                        class="form-input" 
                        style="width: 100%; height: 100px; max-width: 800px;"
                        required
                        placeholder="Please provide your answer here..."></textarea>
                </div>

                <button type="submit" class="continue-btn">
                    Submit <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        `,
        data: {
            task: 'final_questions'
        }
    };

    // NEW - Replace your existing createBalancedDesign function with this one
    function createBalancedDesign(stimuliArray = stimuli) {
        const shuffledStimuli = jsPsych.randomization.shuffle([...stimuliArray]);
        return {
            A: shuffledStimuli.slice(0, 2),
            B: shuffledStimuli.slice(2, 4),
            C: shuffledStimuli.slice(4, 6)
        };
    }

   // Function to count words
   function countWords(text) {
       return text.trim().split(/\s+/).filter(word => word.length > 0).length;
   }


   // Function to check response and handle validation
   function checkResponse(button) {
       const form = button.closest('form');
       const response = form.querySelector('textarea[name="response"]').value;
       const wordCount = countWords(response);


       if (wordCount < 30) {
           alert("Your response must be at least 30 words long. Please add more detail to your response.");
           return false;
       }


       // If validation passes, submit the form programmatically
       form.dispatchEvent(new Event('submit', { cancelable: true }));
   }
    // Function to create a trial
    function createTrial(stimulus, condition) {
        const decemberDay = Math.floor(Math.random() * 31) + 1;
        const decemberHour = Math.floor(Math.random() * 24);
        const decemberMinute = Math.floor(Math.random() * 60);
        const timestamp = new Date(2023, 11, decemberDay, decemberHour, decemberMinute)
            .toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric'
            });

        let socialConditionText;
        switch(condition) {
            case 'A':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant
                            <span class="participant-id">${PARTICIPANT_IDS.artwork.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I like it a lot.'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response - </span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'B':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant
                            <span class="participant-id">${PARTICIPANT_IDS.artwork.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I do not like it at all'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response - </span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'C':
                socialConditionText = `
                    <div class="social-condition">
                        <p class="no-preference-text">No preference from previous participant available.</p>
                        <div class="system-info">
                            <span class="system-text">System status</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
        }

        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Artwork:</h2>
                    <img src="${stimulus.image}" class="artwork-image" alt="Artwork">
                    ${socialConditionText}
                    <div class="opinion-section">
                        <p class="question-text">What is your opinion of the artwork above?</p>
                        <textarea id="response" name="response" 
                            placeholder="Please write your brief answer here (30-100 words):"></textarea>
                        <button type="button" class="continue-btn" onclick="checkResponse(this)">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `,
            data: {
                stimulus_id: stimulus.id,
                condition: condition,
                image: stimulus.image
            },
            on_load: function() {
                document.querySelector('form').onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
            
                const textarea = document.querySelector('textarea[name="response"]');
                if (textarea) {
                   // Disabled temporarily
                   //  disableCopyPaste(textarea);
                }
            },
        };
    }
    
     
   
   // Helper function to get CSS color values
   function getColorValue(colorName) {
       // Map color names to CSS color values
       const colorMap = {
           'Blue': '#0000FF',
           'Yellow': '#FFD700', // Using a slightly darker yellow for better visibility
           'Green': '#008000',
           'Orange': '#FFA500',
           'Black': '#050003',
           'Red': '#FF0000',
           'Brown': '#8B4513',
           'Pink': '#FC47A2',
           'Purple': '#4C0082'
       };
       return colorMap[colorName] || colorName;
   }

   // NEW Add this new function after createTrial
    function createColorTrial(stimulus, condition) {
        const decemberDay = Math.floor(Math.random() * 31) + 1;
        const decemberHour = Math.floor(Math.random() * 24);
        const decemberMinute = Math.floor(Math.random() * 60);
        const timestamp = new Date(2023, 11, decemberDay, decemberHour, decemberMinute)
            .toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric'
            });

        // Split the color combination into individual colors
        const colors = stimulus.combination.split(' and ');
        
        // Create colored spans for each color
        const coloredText = `
            <span style="color: ${getColorValue(colors[0])}; font-weight: bold;">${colors[0]}</span>
            and
            <span style="color: ${getColorValue(colors[1])}; font-weight: bold;">${colors[1]}</span>
        `;

        let socialConditionText;
        switch(condition) {
            case 'A':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.colors.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I like it a lot'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'B':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.colors.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">"I do not like it at all"</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'C':
                socialConditionText = `
                    <div class="social-condition">
                        <p class="no-preference-text">No preference from previous participant available.</p>
                        <div class="system-info">
                            <span class="system-text">System status</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
        }

        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Colour Combination:</h2>
                    <div style="font-size: 24px; margin: 40px 0; text-align: center; background-color: #f5f5f5; padding: 20px; border-radius: 8px;">
                        ${coloredText}
                    </div>
                    ${socialConditionText}
                    <div class="opinion-section">
                        <p class="question-text">What is your opinion of the colour combination above?</p>
                        <textarea id="response" name="response" 
                            placeholder="Please write your brief answer here (30-100 words):"></textarea>
                        <button type="button" class="continue-btn" onclick="checkResponse(this)">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `,
            data: {
                stimulus_id: stimulus.id,
                condition: condition,
                combination: stimulus.combination,
                task: 'color_combinations'
            },
            on_load: function() {
                document.querySelector('form').onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };

                const textarea = document.querySelector('textarea[name="response"]');
                if (textarea) {
                    // Disabled temporarily
                    //disableCopyPaste(textarea);
                }
            },
        };
    }

    // Create shape trial function
   function createShapeTrial(stimulus, condition) {
        const decemberDay = Math.floor(Math.random() * 31) + 1;
        const decemberHour = Math.floor(Math.random() * 24);
        const decemberMinute = Math.floor(Math.random() * 60);
        const timestamp = new Date(2023, 11, decemberDay, decemberHour, decemberMinute)
            .toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric'
            });

        let socialConditionText;
        switch(condition) {
            case 'A':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.shapes.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I like it a lot'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'B':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.shapes.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I do not like it at all'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'C':
                socialConditionText = `
                    <div class="social-condition">
                        <p class="no-preference-text">No preference from previous participant available.</p>
                        <div class="system-info">
                            <span class="system-text">System status</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
        }

        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Shape:</h2>
                    <img src="${stimulus.image}" class="artwork-image" alt="Shape">
                    ${socialConditionText}
                    <div class="opinion-section">
                        <p class="question-text">What is your opinion of the shape above?</p>
                        <textarea id="response" name="response" 
                            placeholder="Please write your brief answer here (30-100 words):"></textarea>
                        <button type="button" class="continue-btn" onclick="checkResponse(this)">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `,
            data: {
                stimulus_id: stimulus.id,
                condition: condition,
                image: stimulus.image,
                task: 'shape_task'
            },
            on_load: function() {
                document.querySelector('form').onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
                
                const textarea = document.querySelector('textarea[name="response"]');
                if (textarea) {
                    // Disabled temporarily
                    //disableCopyPaste(textarea);
                }
            },
        };
    }

    function createTrendTrial(stimulus, condition) {
        const decemberDay = Math.floor(Math.random() * 31) + 1;
        const decemberHour = Math.floor(Math.random() * 24);
        const decemberMinute = Math.floor(Math.random() * 60);
        const timestamp = new Date(2023, 11, decemberDay, decemberHour, decemberMinute)
            .toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true,
                month: 'short',
                day: 'numeric'
            });

        let socialConditionText;
        switch(condition) {
            case 'A':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.trends.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I like it a lot'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'B':
                socialConditionText = `
                    <div class="social-condition">
                        <p>
                            Preference from previous participant 
                            <span class="participant-id">${PARTICIPANT_IDS.trends.substring(0, 2)}${'•'.repeat(22)}</span>
                            <span class="preference-container">
                                <span class="preference-label">Selected:</span>
                                <span class="preference-text">'I do not like it at all'</span>
                            </span>
                        </p>
                        <div class="system-info">
                            <span class="system-text">System retrieved previous response</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
            case 'C':
                socialConditionText = `
                    <div class="social-condition">
                        <p class="no-preference-text">No preference from previous participant available.</p>
                        <div class="system-info">
                            <span class="system-text">System status</span>
                            <span class="timestamp">${timestamp}</span>
                        </div>
                    </div>`;
                break;
        }

        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Tech innovation:</h2>
                    <div style="font-size: 24px; margin: 40px 0; text-align: center; background-color: #f5f5f5; padding: 20px; border-radius: 8px;">
                        ${stimulus.trend}
                    </div>
                    ${socialConditionText}
                    <div class="opinion-section">
                        <p class="question-text">What is your opinion of the tech innovation above?</p>
                        <textarea id="response" name="response" 
                            placeholder="Please write your brief answer here (30-100 words):"></textarea>
                        <button type="button" class="continue-btn" onclick="checkResponse(this)">
                            Continue <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `,
            data: {
                stimulus_id: stimulus.id,
                condition: condition,
                trend: stimulus.trend,
                task: 'trend_task'
            },
            on_load: function() {
                document.querySelector('form').onsubmit = function(e) {
                    e.preventDefault();
                    return false;
                };
                
                const textarea = document.querySelector('textarea[name="response"]');
                if (textarea) {
                    // Disabled temporarily
                    //disableCopyPaste(textarea);
                }
            },
        };
    }

    function createColorAttentionCheck() {
        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Quick Question:</h2>
                    <div class="form-group">
                        <label class="question-label" style="font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                            What was the second colour in the combination you just saw?
                        </label>
                        <div class="radio-options-vertical" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                            ${jsPsych.randomization.shuffle([
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Green" required>
                                    <span>Green</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="White" required>
                                    <span>White</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Yellow" required>
                                    <span>Yellow</span>
                                </label>`
                            ]).join('')}
                        </div>
                    </div>
                    <button type="submit" class="continue-btn">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `,
            data: {
                task: 'attention_check_color'
            }
        };
    }

    function createShapeAttentionCheck() {
        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Quick Question:</h2>
                    <div class="form-group">
                        <label class="question-label" style="font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                            What was the shape you just saw?
                        </label>
                        <div class="radio-options-vertical" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                            ${jsPsych.randomization.shuffle([
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Rectangle" required>
                                    <span>Rectangle</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Triangle" required>
                                    <span>Triangle</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Star" required>
                                    <span>Star</span>
                                </label>`
                            ]).join('')}
                        </div>
                    </div>
                    <button type="submit" class="continue-btn">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `,
            data: {
                task: 'attention_check_shape'
            }
        };
    }

    function createArtworkAttentionCheck(condition) {
        return {
            type: jsPsychSurveyHtmlForm,
            html: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div class="artwork-container">
                    <h2 class="artwork-heading">Quick Question:</h2>
                    <div class="form-group">
                        <label class="question-label" style="font-weight: bold; font-size: 1.2em; margin-bottom: 20px;">
                            What was the previous participant's preference, which you just saw?
                        </label>
                        <div class="radio-options-vertical" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                            ${jsPsych.randomization.shuffle([
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Liked" required>
                                    <span>Liked the artwork</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="Disliked" required>
                                    <span>Disliked the artwork</span>
                                </label>`,
                                `<label class="radio-option" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="attention_check" value="NoPreference" required>
                                    <span>No preference was available</span>
                                </label>`
                            ]).join('')}
                        </div>
                    </div>
                    <button type="submit" class="continue-btn">
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `,
            data: {
                task: 'attention_check_artwork',
                correct_answer: condition === 'A' ? 'Liked' : 
                            condition === 'B' ? 'Disliked' : 
                            'NoPreference'
            }
        };
    }

   // Demographics page`
   const demographics = {
        type: jsPsychSurveyHtmlForm,
        html: `
            <style>
                .select-dropdown {
                    width: 100%;
                    max-width: 300px;
                    padding: 8px;
                    margin-top: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 16px;
                    font-family: 'Poppins', sans-serif;
                    background-color: white;
                    display: block;
                }
                
                .form-group {
                    margin-bottom: 30px;
                }
                
                .question-label {
                    display: block;
                    margin-bottom: 10px;
                    font-weight: bold;
                }
                
                .other-input {
                    width: 100%;
                    max-width: 300px;
                    padding: 8px;
                    margin-top: 10px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 16px;
                    display: none;
                }
            </style>
            <div class="banner">
                <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
            </div>
            <div class="instructions">
                <h2><strong>Demographics Information</strong></h2>
            
                <div class="form-group">
                    <label class="question-label" for="age">How old are you (in years)?</label>
                    <input type="number" id="age" name="age" class="select-dropdown" required min="18" max="100">
                </div>
            
                <div class="form-group">
                    <label class="question-label" for="gender">With which gender do you identify most?</label>
                    <select id="gender" name="gender" class="select-dropdown" required onchange="toggleOtherGender(this.value)">
                        <option value="" disabled selected>Please select...</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="nonbinary">Non-binary</option>
                        <option value="other">Other</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                    </select>
                    <input type="text" id="gender_other" name="gender_other" class="other-input" placeholder="Please specify your gender">
                </div>

                <div class="form-group">
                    <label class="question-label" for="ethnicity">What is your ethnicity?</label>
                    <select id="ethnicity" name="ethnicity" class="select-dropdown" required>
                        <option value="" disabled selected>Please select...</option>
                        <option value="white">White</option>
                        <option value="black">Black or African American</option>
                        <option value="asian">Asian</option>
                        <option value="hispanic">Hispanic or Latino</option>
                        <option value="native">Native American or Alaska Native</option>
                        <option value="pacific">Native Hawaiian or Other Pacific Islander</option>
                        <option value="mixed">Mixed Race</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="question-label" for="education">What is your highest level of education?</label>
                    <select id="education" name="education" class="select-dropdown" required>
                        <option value="" disabled selected>Please select...</option>
                        <option value="primary_school">Primary school</option>
                        <option value="middle_school">Middle school graduate (e.g. GCSEs or equivalent)</option>
                        <option value="high_school">High school graduate (e.g. A level or equivalent)</option>
                        <option value="bachelor">Bachelor's degree (or equivalent)/option>
                        <option value="Mmaster">Master's degree (or equivalent)/option>
                        <option value="doctorate">PhD/ Doctorate degree (or higher)</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="question-label" for="income">What is the annual gross income of your household (your income before tax deduction)?</label>
                    <select id="income" name="income" class="select-dropdown" required>
                        <option value="" disabled selected>Please select...</option>
                        <option value="0_25k">£0 - £25,000</option>
                        <option value="25k_50k">£25,001 - £50,000</option>
                        <option value="50k_75k">£50,001 - £75,000</option>
                        <option value="75k_100k">£75,001 - £100,000</option>
                        <option value="100k_150k">£100,001 - £150,000</option>
                        <option value="150k_plus">More than £150,000</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                    </select>
                </div>
            
                <button type="submit" class="continue-btn">
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        `
    };

    // Add the toggleOtherGender function to the global scope
    if (typeof window !== 'undefined') {
        window.toggleOtherGender = function(value) {
            const otherInput = document.getElementById('gender_other');
            otherInput.style.display = value === 'other' ? 'block' : 'none';
            if (value !== 'other') {
                otherInput.value = '';
            }
        };
    }

    function createMatchingPage(taskType) {
        const participantId = PARTICIPANT_IDS[taskType];
        return {
            type: jsPsychHtmlButtonResponse,
            stimulus: `
                <div class="banner">
                    <img src="MITLogo.jpg" alt="MIT Sloan School of Management">
                </div>
                <div id="matching-content">
                    <div class="loading-container" id="loadingContainer">
                        <p class="loading-text">One moment please, you are now being matched with a pilot study participant.</p>
                        <div class="spinner"></div>
                    </div>
                    
                    <div class="matching-result" id="matchedResult">
                        <p class="matching-text">You are matched with:</p>
                        <div class="matched-name-container">
                            <span class="participant-id">${participantId.substring(0, 2)}${'•'.repeat(22)}</span>
                        </div>
                    </div>
                </div>
            `,
            choices: ['Continue'],
            button_html: '<button class="continue-btn">%choice% <i class="fas fa-arrow-right"></i></button>',
            on_load: function() {
                document.querySelector('.jspsych-html-button-response-button').style.display = 'none';
                setTimeout(function() {
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('matchedResult').style.display = 'block';
                    document.querySelector('.jspsych-html-button-response-button').style.display = 'inline-block';
                }, 2000);
            }
        };
    }

    function createTimeline() {
        // Initial fixed elements
        const initialTimeline = [
            prolificId,
            welcomeScreen,
            consentInfo1,
            consentInfo2,
            demographics
        ];

        // Create the artwork task block
        function createArtworkBlock(isFirst) {
            const artworkAssignments = createBalancedDesign(stimuli);
            const artworkTrials = [];
            
            let allTrials = [];
            
            for (let condition in artworkAssignments) {
                artworkAssignments[condition].forEach(stimulus => {
                    const trial = createTrial(stimulus, condition);
                    
                    // If this is artwork4 (id: 4)
                    if (stimulus.id === 4) {
                        allTrials.push({
                            mainTrial: trial,
                            attentionCheck: createArtworkAttentionCheck(condition),
                            isAttentionPair: true
                        });
                    } else {
                        allTrials.push({
                            mainTrial: trial,
                            isAttentionPair: false
                        });
                    }
                });
            }
            
            allTrials = jsPsych.randomization.shuffle(allTrials);
            
            for (let trialItem of allTrials) {
                artworkTrials.push(trialItem.mainTrial);
                if (trialItem.isAttentionPair) {
                    artworkTrials.push(trialItem.attentionCheck);
                }
            }

            return [
                ...(isFirst ? [] : [transitionScreen]),
                taskInstructions,
                createMatchingPage("artwork"),
                ...artworkTrials
            ];
        }

        // Create the color task block
        function createColorBlock(isFirst) {
            const colorAssignments = createBalancedDesign(colorStimuli);
            const colorTrials = [];
            let allTrials = [];
            // Process each condition and its stimuli
            for (let condition in colorAssignments) {
                colorAssignments[condition].forEach(stimulus => {
                    // Create the regular trial
                    const trial = createColorTrial(stimulus, condition);
                    
                    // If this is the Blue and Yellow combination (id: 1)
                    if (stimulus.id === 1) {
                        // Create a pair of the trial and its attention check
                        allTrials.push({
                            mainTrial: trial,
                            attentionCheck: createColorAttentionCheck(),
                            isAttentionPair: true
                        });
                    } else {
                        // Add regular trial without attention check
                        allTrials.push({
                            mainTrial: trial,
                            isAttentionPair: false
                        });
                    }
                });
            }
            
            // Randomize the order of trials while keeping pairs together
            allTrials = jsPsych.randomization.shuffle(allTrials);
            
            // Flatten the trials back into a single array
            for (let trialItem of allTrials) {
                colorTrials.push(trialItem.mainTrial);
                if (trialItem.isAttentionPair) {
                    colorTrials.push(trialItem.attentionCheck);
                }
            }

            return [
                ...(isFirst ? [] : [transitionScreen]),
                colorTaskInstructions,
                createMatchingPage("colors"),
                ...colorTrials
            ];
        }

        function createTrendBlock(isFirst) {
            const trendAssignments = createBalancedDesign(trendStimuli);
            const trendTrials = [];
            for (let condition in trendAssignments) {
                trendAssignments[condition].forEach(stimulus => {
                    const trial = createTrendTrial(stimulus, condition);
                    const originalOnFinish = trial.on_finish || function() {};
                    trial.on_finish = function(data) {
                        originalOnFinish(data);
                        jsPsych.setProgressBar(data.trial_index / totalTrials);
                    };
                    trendTrials.push(trial);
                });
            }
            return [
                ...(isFirst ? [] : [trendTransitionScreen]),
                trendTaskInstructions,
                createMatchingPage("trends"),
                ...jsPsych.randomization.shuffle(trendTrials)
            ];
        }

        function createShapeBlock(isFirst) {
            const shapeAssignments = createBalancedDesign(shapeStimuli);
            const shapeTrials = [];
            
            let allTrials = [];
            
            for (let condition in shapeAssignments) {
                shapeAssignments[condition].forEach(stimulus => {
                    const trial = createShapeTrial(stimulus, condition);
                    
                    // If this is the triangle (id: 2)
                    if (stimulus.id === 2) {
                        allTrials.push({
                            mainTrial: trial,
                            attentionCheck: createShapeAttentionCheck(),
                            isAttentionPair: true
                        });
                    } else {
                        allTrials.push({
                            mainTrial: trial,
                            isAttentionPair: false
                        });
                    }
                });
            }
            
            allTrials = jsPsych.randomization.shuffle(allTrials);
            
            for (let trialItem of allTrials) {
                shapeTrials.push(trialItem.mainTrial);
                if (trialItem.isAttentionPair) {
                    shapeTrials.push(trialItem.attentionCheck);
                }
            }

            return [
                ...(isFirst ? [] : [shapeTransitionScreen]),
                shapeTaskInstructions,
                createMatchingPage("shapes"),
                ...shapeTrials
            ];
        }

        // Create task blocks with their creation functions
        const taskBlocks = [
            { type: 'artwork', createBlock: createArtworkBlock },
            { type: 'colors', createBlock: createColorBlock },
            { type: 'shapes', createBlock: createShapeBlock },
            { type: 'trends', createBlock: createTrendBlock }
        ];

        // Randomize the order of task blocks
        const randomizedBlocks = jsPsych.randomization.shuffle(taskBlocks);

        // Build the final timeline
        let timeline = [...initialTimeline];
        
        // Add each task block
        randomizedBlocks.forEach((taskBlock, index) => {
            const isFirst = index === 0;
            timeline.push(...taskBlock.createBlock(isFirst));
        });

        timeline.push(finalQuestions);
        const totalTrials = timeline.reduce((count, trial) => {
            if (trial.type === 'survey-html-form') {
                return count + 1;
            }
            return count;
        }, 0);

        return timeline;
    }

   // Run the experiment
   jsPsych.run(createTimeline());
   </script>
</body>
</html>

